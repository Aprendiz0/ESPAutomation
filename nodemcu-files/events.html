<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPAutomation - Events</title>
    <style>
        html,
        body {
            padding: 0;
            margin: 0;
        }

        table {
            border-collapse: collapse;
        }

        table,
        th,
        td {
            border: 1px solid black;
        }

        td {
            padding: 10px;
            vertical-align: top;
        }

        a {
            cursor: pointer;
            color: blue;
        }

        #inScreen {
            position: absolute;
            top: 0;
            width: 100%;
            height: 100px;
            text-align: center;
        }

        #inScreen>div {
            margin: 30px 10px 10px 10px;
            padding: 30px;
            min-width: 100px;
            background-color: white;
            border: 1px solid;
            display: inline-block;
            text-align: left;
        }
    </style>
</head>

<body>
    <div style="padding: 10px;">
        <h1>Events</h1>
        <br />

        <p>
            <a onclick="addEvent()">Add</a>
            <br />
            <br />
            <a onclick="save()">Save</a>
        </p>

        <br />
        <br />
        <table>
            <thead>
                <tr>
                    <td>Event Id</td>
                    <td>Name</td>
                    <td>Start in</td>
                    <td>Action</td>
                    <td> -- </td>
                </tr>
            </thead>
            <tbody id="prinpipalTable">

            </tbody>
        </table>
    </div>

    <div id="inScreen" style="display: none;">
        <div>
            <h3>Confirm the data</h3>
            <pre id="printJson"></pre>
            <br />
            <p>
                <a onclick="cancel()">Cancel</a>
                &nbsp; &nbsp; &nbsp;
                <a onclick="doSave()">Save</a>
            </p>
        </div>
    </div>
</body>

<script>

    const eventLineStructure = `
        <tr id="eventLine_&1">
            <td><input type="text" id="id_&1" value=""></td>
            <td><input type="text" id="name_&1"></td>
            <td>
                Start condition: 
                <select id="condicion_&1">
                    <option value="" selected>Select one</option>
                    <option value="0">and</option>
                    <option value="1">or</option>
                </select>
                <br />
                <br />
                <a onclick="addStart('&1')">Add</a>
                <br />
                <br />
                <table>
                    <thead>
                        <tr>
                            <td>Type</td>
                            <td>Parameters</td>
                            <td> -- </td>
                        </tr>
                    </thead>
                    <tbody id="startTable_&1"></tbody>
                </table>
            </td>
            <td>
                <br />
                <br />
                <a onclick="addAction('&1')">Add</a>
                <br />
                <br />
                <table>
                    <thead>
                        <tr>
                            <td>Type</td>
                            <td>Parameters</td>
                            <td> -- </td>
                        </tr>
                    </thead>
                    <tbody id="actionTable_&1"></tbody>
                </table>
            </td>
            <td>
                <a onclick="removeEvent('&1')">Delete</a>
            </td>
        </tr>
    `;

    const eventStartStructure = `
        <tr id="startLine_&1_&2">
            <td>
                <select id="startType_&1_&2">
                    <option value="" selected>Select one</option>
                    <option value="0">alone</option>
                    <option value="1">gpioRead</option>
                </select>
            </td>
            <td id="startParamTd_&1_&2">
            </td>
            <td>
                <a onclick="removeStart('&1','&2')">Delete</a>
            </td>
        </tr>
    `;

    const eventActionStructure = `
        <tr id="actionLine_&1_&2">
            <td>
                <select id="actionType_&1_&2">
                    <option value="" selected>Select one</option>
                    <option value="0">gpioWrite</option>
                    <option value="1">Dispacth event</option>
                </select>
            </td>
            <td id="actionParamTd_&1_&2">
            </td>
            <td>
                <a onclick="removeAction('&1','&2')">Delete</a>
            </td>
        </tr>
    `;

    const eventActionDispacthEventStructure = `
                <input type="text" name="val" placeholder="Event Id">
    `;

    const eventStartActionGpioStructure = `
                <input type="text" name="pin" placeholder="pin">
                <br />
                <input type="text" name="val" placeholder="val">
    `;

    let eventsRegistred = [];
    let counts = {
        eventId: 0,
        startId: 0,
        actionId: 0,
    }

    function getEId(id, comp, eName) {
        let idE = id;
        if (typeof comp != 'undefined') idE += comp.toString();

        if (typeof eName === 'undefined')
            return document.getElementById(idE);
        else
            return document.querySelectorAll(('#' + idE + ' > ' + eName));
    }

    function addEvent() {
        let event = {
            id: counts.eventId++,
            starts: [],
            actions: []
        };

        getEId('prinpipalTable')
            .insertAdjacentHTML('beforeend',
                eventLineStructure.replace(/&1/g, event.id));
        eventsRegistred[event.id.toString()] = event;
    }

    function addStart(evId) {
        let startId = counts.startId++

        getEId('startTable_' + evId)
            .insertAdjacentHTML('beforeend',
                eventStartStructure.replace(/&1/g, evId).replace(/&2/g, startId));

        let paramTd = getEId('startParamTd_', (evId + '_' + startId))
        paramTd.innerHTML = '';

        getEId('startType_' + evId + '_' + startId).addEventListener("change", function () {
            paramTd.innerHTML = '';
            switch (this.value) {
                case '1':
                    paramTd.innerHTML = eventStartActionGpioStructure;
                    break;
                default:
                    break;
            }
        })

        eventsRegistred[evId].starts[startId] = startId;
    }

    function addAction(evId) {
        let actionId = counts.actionId++

        getEId('actionTable_' + evId).insertAdjacentHTML('beforeend',
            eventActionStructure.replace(/&1/g, evId).replace(/&2/g, actionId));

        let paramTd = getEId('actionParamTd_', (evId + '_' + actionId))

        getEId('actionType_' + evId + '_' + actionId).addEventListener("change", function () {
            paramTd.innerHTML = '';
            switch (this.value) {
                case '0':
                    paramTd.innerHTML = eventStartActionGpioStructure;
                    break;
                case '1':
                    paramTd.innerHTML = eventActionDispacthEventStructure;
                    break;
                default:
                    break;
            }
        })

        eventsRegistred[evId].actions[actionId] = actionId;
    }

    function removeStart(evId, stId) {
        getEId('startLine_' + evId + '_' + stId).remove();
        delete eventsRegistred[evId].actions[stId];
    }

    function removeAction(evId, stId) {
        getEId('actionLine_' + evId + '_' + stId).remove();
        delete eventsRegistred[evId].actions[stId];
    }

    function removeEvent(evId) {
        getEId('eventLine_' + evId).remove();
        delete eventsRegistred[evId];
    }

    function getEventsStructure() {

        eventsReg = [];

        for (const eKey in eventsRegistred) {
            const eventKey = eventsRegistred[eKey];
            const eId = eventKey.id;
            const eventId = getEId('id_', eId).value;

            if (eventId === "") continue;

            let event = {
                id: eventId,
                name: getEId('name_', eId).value,
                startCondition: getEId('condicion_', eId).value,
                starts: [],
                actions: []
            }

            for (const sKey in eventKey.starts) {
                const startKey = eventKey.starts[sKey];
                const startType = getEId('startType_', (eId + '_' + startKey)).value;

                if (startType === "") continue;

                event.starts.push({
                    //id: startKey,
                    type: startType,
                    param: getStartParam()
                })

                function getStartParam() {
                    let r = {}
                    let ips = getEId('startParamTd_', (eId + '_' + startKey), 'input');

                    for (let k = 0; k < ips.length; k++) {
                        const ip = ips[k];
                        r[ip.name] = ip.value;
                    }

                    return r
                }
            }

            for (const aKey in eventKey.actions) {
                const actionKey = eventKey.actions[aKey];
                const actionType = getEId('actionType_', (eId + '_' + actionKey)).value;

                if (actionType === "") continue;

                event.actions.push({
                    //id: actionKey,
                    type: actionType,
                    param: getEId('actionParam_', (eId + '_' + actionKey)).value
                })

                function getActionParam() {
                    let r = {}
                    let ips = getEId('startParamTd_', (eId + '_' + startKey), 'input');

                    for (let k = 0; k < ips.length; k++) {
                        const ip = ips[k];
                        r[ip.name] = ip.value;
                    }

                    return r
                }
            }

            eventsReg.push(event);
        }

        return eventsReg;

    }

    function save() {
        getEId('inScreen').style.display = "";
        getEId('printJson').textContent = JSON.stringify(getEventsStructure(), undefined, 2);
    }

    function cancel() {
        getEId('inScreen').style.display = "none";
        getEId('printJson').textContent = ""
    }

    function doSave() {
        fetch('events/set', { method: 'POST', body: JSON.stringify(getEventsStructure()) })
            .then(function (response) {
                return response.json();
            })
            .then(function (rjson) {
                console.log(rjson)
            });
        //alert('Aguarde a página se atualizar');
        //window.location.reload();
    }

</script>

</html>